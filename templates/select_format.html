<!DOCTYPE html>
<html lang="en">
        <head>
            <meta charset="utf-8" />
            <meta name="viewport" content="width=device-width,initial-scale=1" />
            <title>Select Format - {{ title }}</title>
            <script src="https://cdn.tailwindcss.com"></script>
        </head>
        <body class="bg-gray-100 min-h-screen flex items-center justify-center p-6">
            <div class="bg-white rounded-lg shadow-lg max-w-4xl w-full p-6">
                <div class="grid md:grid-cols-3 gap-6">
                    <div class="md:col-span-2">
                        <h2 class="text-xl font-semibold">{{ title }}</h2>

                        <!-- Video preview -->
                                    <div class="mt-4">
                                        {% if thumbnail %}
                                            <video id="player" controls poster="{{ thumbnail }}" class="w-full rounded bg-black">
                                                Your browser does not support the video tag.
                                            </video>
                                        {% else %}
                                            <div class="w-full h-48 bg-gray-200 rounded"></div>
                                        {% endif %}
                                        <div id="previewStatus" class="text-xs text-gray-500 mt-2">Preview: not loaded</div>
                                    </div>

                        <!-- Trimming timeline -->
                        <div class="mt-4">
                            <label class="block text-sm text-gray-700">Trim selection</label>
                            <div class="mt-2">
                                <div class="w-full bg-gray-100 rounded p-3">
                                    <div class="flex items-center gap-3">
                                                        <div class="flex-1 relative">
                                                                <div class="relative h-8">
                                                                      <input id="startRange" type="range" min="0" max="{{ duration or 0 }}" value="0" step="1" class="absolute inset-0 w-full opacity-0" />
                                                                      <input id="endRange" type="range" min="0" max="{{ duration or 0 }}" value="{{ duration or 0 }}" step="1" class="absolute inset-0 w-full opacity-0" />
                                                                    <div id="sliderTrack" class="absolute left-0 right-0 top-3 h-2 bg-gray-200 rounded"></div>
                                                                    <div id="sliderRange" class="absolute top-3 h-2 bg-indigo-400 rounded" style="left:0%; right:0%;"></div>
                                                                    <div id="leftHandle" class="absolute top-0 w-4 h-4 bg-white border rounded-full shadow -translate-y-1/2" style="left:0%"></div>
                                                                    <div id="rightHandle" class="absolute top-0 w-4 h-4 bg-white border rounded-full shadow -translate-y-1/2" style="left:100%"></div>
                                                                </div>
                                                            </div>
                                        <div class="w-36 text-sm text-gray-600">
                                            <div>Start: <span id="startLabel">0:00</span></div>
                                            <div>End: <span id="endLabel">0:00</span></div>
                                        </div>
                                    </div>
                                    <div class="text-xs text-gray-500 mt-2">Drag the handles to select the trim region. Use the player to preview.</div>
                                </div>
                            </div>
                        </div>

                        <!-- Format list and submit -->
                        <form method="POST" action="{{ url_for('start_download') }}" class="mt-4 space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Format</label>
                                <select name="format_id" id="format_id" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                    {% for f in formats %}
                                                    <option value="{{ f.format_id }}">{{ f.label }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="flex items-center gap-4">
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" name="extract_audio" value="yes" class="h-4 w-4" />
                                    <span class="text-sm">Download audio only (mp3)</span>
                                </label>
                            </div>

                            <input type="hidden" name="start_time" id="start_time_input" />
                            <input type="hidden" name="end_time" id="end_time_input" />

                            <div class="flex items-center gap-3">
                                <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded">Start Download</button>
                                <a href="{{ url_for('index') }}" class="text-sm text-gray-600">‚Üê Back</a>
                            </div>
                        </form>
                    </div>

                    <div class="md:col-span-1">
                        <div class="bg-gray-50 border rounded p-4">
                            <h3 class="font-medium">Preview & Info</h3>
                              <p class="text-sm text-gray-600 mt-2">Duration: <span id="durationText">{{ duration or 'unknown' }}</span> seconds</p>
                            <p class="text-sm text-gray-600 mt-2">Thumbnail shown if available.</p>
                        </div>
                    </div>
                </div>

                    <script>
                // Simple helper to format seconds to H:MM:SS
                function fmt(s) {
                    s = Number(s) || 0;
                    const h = Math.floor(s / 3600);
                    const m = Math.floor((s % 3600) / 60);
                    const sec = Math.floor(s % 60);
                    return (h ? h + ':' : '') + String(m).padStart(h ? 2 : 1, '0') + ':' + String(sec).padStart(2, '0');
                }

                const startRange = document.getElementById('startRange');
                const endRange = document.getElementById('endRange');
                const sliderRange = document.getElementById('sliderRange');
                const leftHandle = document.getElementById('leftHandle');
                const rightHandle = document.getElementById('rightHandle');
                const previewStatus = document.getElementById('previewStatus');
                const startLabel = document.getElementById('startLabel');
                const endLabel = document.getElementById('endLabel');
                const startInput = document.getElementById('start_time_input');
                const endInput = document.getElementById('end_time_input');
                const player = document.getElementById('player');

                function syncLabels() {
                    const s = Number(startRange.value);
                    const e = Number(endRange.value);
                    startLabel.innerText = fmt(s);
                    endLabel.innerText = fmt(e);
                    startInput.value = s;
                    endInput.value = e;
                    if (player && !isNaN(player.duration)) {
                        // keep player currentTime inside range
                        if (player.currentTime < s || player.currentTime > e) player.currentTime = s;
                    }
                            // update visual range
                            const maxv = Number(startRange.max) || 1;
                            const leftPct = (s / maxv) * 100;
                            const rightPct = (e / maxv) * 100;
                            sliderRange.style.left = leftPct + '%';
                            sliderRange.style.width = Math.max(0, rightPct - leftPct) + '%';
                            leftHandle.style.left = leftPct + '%';
                            rightHandle.style.left = rightPct + '%';
                }

                startRange.addEventListener('input', function() {
                    if (Number(startRange.value) > Number(endRange.value)) {
                        endRange.value = startRange.value;
                    }
                    syncLabels();
                });
                endRange.addEventListener('input', function() {
                    if (Number(endRange.value) < Number(startRange.value)) {
                        startRange.value = endRange.value;
                    }
                    syncLabels();
                });

                        // When format changes, request preview
                        const formatSelect = document.getElementById('format_id');
                        formatSelect.addEventListener('change', async function() {
                            const fmt = formatSelect.value;
                            previewStatus.innerText = 'Preview: generating...';
                            try {
                                const res = await fetch(`/generate_preview/${encodeURIComponent('{{ session.video_id }}')}/${encodeURIComponent(fmt)}`);
                                const data = await res.json();
                                if (data.status === 'ready') {
                                    player.src = data.url;
                                    previewStatus.innerText = 'Preview: ready';
                                } else {
                                    previewStatus.innerText = 'Preview: unavailable';
                                }
                            } catch (e) {
                                previewStatus.innerText = 'Preview: error';
                                console.error(e);
                            }
                        });

                        // trigger preview generation for initial selection
                        if (formatSelect.value) formatSelect.dispatchEvent(new Event('change'));

                // initialize
                syncLabels();
            </script>

        </body>
    </html>
